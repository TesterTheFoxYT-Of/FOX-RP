name: Build FOX RP Launcher
on: [workflow_dispatch]

jobs:
  prepare-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. Установка инструментов
      - name: Install ImageMagick
        run: sudo apt-get install -y imagemagick

      # 2. Загрузка логотипа
      - name: Download Logo
        run: |
          curl -L "https://raw.githubusercontent.com/TesterTheFoxYT-Of/FOX-RP/main/images.jpeg" -o logo_raw.jpg

      # 3. Настройка серверов, КЭША и отключение Новогоднего режима
      - name: Configure FOX RP Settings
        run: |
          mkdir -p src/constants
          
          # Настройка серверов
          echo 'export const SERVERS = [
            { name: "FOX RP | ICE", ip: "188.127.241.74", port: 2329 },
            { name: "FOX RP | BLACK", ip: "188.127.241.74", port: 3274 },
            { name: "FOX RP | WHITE", ip: "188.127.241.74", port: 1453 }
          ];' > src/constants/servers.ts
          
          # Настройка .env (прописываем кэш и отключаем выбор)
          echo "URL_DISTRIBUTION=https://www.dropbox.com/scl/fi/g4791eve3lfu8t29imu75/cache.zip?rlkey=8y4ani8ol494h7fq40zph7vkz&st=jr1mhztx&dl=1" > .env
          echo "LINK_SITE=https://github.com/TesterTheFoxYT-Of/FOX-RP" >> .env
          echo "DEFAULT_CACHE_TYPE=standard" >> .env
          echo "ENABLE_WINTER_MODE=false" >> .env

          # Хак: Принудительно отключаем выбор в коде (если файлы существуют)
          sed -i 's/showCacheSelect: true/showCacheSelect: false/g' src/config/index.ts 2>/dev/null || true
          sed -i 's/isWinter: true/isWinter: false/g' src/config/index.ts 2>/dev/null || true

      # 4. Генерация иконок
      - name: Generate Android Icons
        run: |
          mkdir -p android/app/src/main/res/mipmap-mdpi
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          convert logo_raw.jpg -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert logo_raw.jpg -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert logo_raw.jpg -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert logo_raw.jpg -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert logo_raw.jpg -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          cp android/app/src/main/res/mipmap-mdpi/ic_launcher.png android/app/src/main/res/mipmap-mdpi/ic_launcher_round.png
          cp android/app/src/main/res/mipmap-hdpi/ic_launcher.png android/app/src/main/res/mipmap-hdpi/ic_launcher_round.png
          cp android/app/src/main/res/mipmap-xhdpi/ic_launcher.png android/app/src/main/res/mipmap-xhdpi/ic_launcher_round.png
          cp android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png android/app/src/main/res/mipmap-xxhdpi/ic_launcher_round.png
          cp android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png android/app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png

      # 5. Сборка
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install Dependencies
        run: npm install

      - name: Build Android Release
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon

      # 6. Выгрузка APK
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: FOX-RP-Launcher
          path: android/app/build/outputs/apk/release/*.apk
